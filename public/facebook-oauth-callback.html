<!DOCTYPE html>
<html>
<head>
    <title>Facebook OAuth Callback</title>
</head>
<body>
    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
        <h2>Connecting to Facebook...</h2>
        <p>Please wait while we complete the connection.</p>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');
        const errorDescription = urlParams.get('error_description');

        console.log('Facebook callback received:', { code: !!code, state: !!state, error, errorDescription });

        if (error) {
            // Handle OAuth error
            console.error('Facebook OAuth error:', error, errorDescription);
            window.opener?.postMessage({
                type: 'FACEBOOK_OAUTH_ERROR',
                error: errorDescription || error
            }, window.location.origin);
            window.close();
        } else if (code) {
            // Handle successful OAuth callback
            // Send the authorization code to our edge function
            // Get auth token from localStorage (Supabase format)
            const getAuthToken = () => {
                try {
                    const authData = localStorage.getItem('sb-wpobzmfjkxffnpddisrc-auth-token');
                    if (authData) {
                        const parsed = JSON.parse(authData);
                        return parsed.access_token;
                    }
                } catch (e) {
                    console.error('Error parsing auth token:', e);
                }
                return '';
            };

            fetch('https://wpobzmfjkxffnpddisrc.supabase.co/functions/v1/facebook-oauth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({
                    action: 'handleCallback',
                    code: code,
                    state: state
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }

                // Notify parent window of successful connection
                window.opener?.postMessage({
                    type: 'FACEBOOK_OAUTH_SUCCESS',
                    user: data.user,
                    pages: data.pages
                }, window.location.origin);
                
                window.close();
            })
            .catch(error => {
                console.error('Error handling Facebook OAuth:', error);
                window.opener?.postMessage({
                    type: 'FACEBOOK_OAUTH_ERROR',
                    error: error.message
                }, window.location.origin);
                window.close();
            });
        } else {
            // No code or error, something went wrong
            window.opener?.postMessage({
                type: 'FACEBOOK_OAUTH_ERROR',
                error: 'No authorization code received'
            }, window.location.origin);
            window.close();
        }
    </script>
</body>
</html>